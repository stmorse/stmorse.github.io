---
layout: post
title: "Autocorrelation in Elo ratings"
categories: journal
date: 2019-06-12
tags: [projects, football, analytics, elo]
---

In [a previous post](), I gave an interpretation of Elo ratings as weights of a logistic regression, updated online a la stochastic gradient descent.

Something that didn't quite fit within this scheme, though, was FiveThirtyEight's **autocorrelation** adjustment.  I work through that **why that term is what it is** in this post, and give a simple extension that seems to increase the predictive accuracy of the Elo ratings.


## Motivation

FiveThirtyEight [uses the following formula](https://fivethirtyeight.com/methodology/how-our-nfl-predictions-work/) for their NFL Elo ratings:

$$
\begin{equation}
R_i^{k+1} = R_i^k + K \cdot M(z) \cdot A(x) \cdot (1 - \sigma(x))(-1)^{1-S_{ij}}
\label{eq:elo}
\end{equation}
$$

where $$z$$ is the game's margin of victory, $$x=R_i^k - R_j^k$$, and

$$
\begin{align*}
M(z) &= \ln (|z|+1) \\
A(x) &= \frac{2.2}{2.2-0.001(-1)^{S_{ij}} x} = \frac{1}{1-(-1)^{S_{ij}}\frac{x}{2200}} \\
S_{ij} &= \begin{cases} 1 & i \text{ wins} \\ 0 & i \text{ loses}\end{cases} \\
\sigma(x) &= \frac{1}{1+10^{-x/400}}
\end{align*}
$$

Let's just ignore ties.

My question is the specific justification for the $$A(x)$$ term: 

- **why this form**, and 
- **why those numbers.**  
 
I'm looking for more than a layman's explanation, which 538 already offers and is the typical answer [elsewhere](https://stats.stackexchange.com/questions/168047/accounting-for-autocorrelation-in-margin-based-elo-ratings).  (Although [this post](https://andr3w321.com/a-note-on-autocorrelation/) goes a bit deeper.)


## Quick intuition

So first you should buy off on the idea that given Team $$i$$'s current rating is $$R_i$$, we should *expect* its rating after the current game to still be $$R_i$$.  For example, we shouldn't ever *expect* Team $$i$$'s rating to increase, because if we did, ["we should have rated them higher to begin with"](https://fivethirtyeight.com/features/introducing-nfl-elo-ratings)!

Put in statistical language, this is the statement that we want $$\mathbb{E}[R_i^{k+1}] = R_i^k$$.

<!---
Finish thought about autocorrelation
--->


## The typical explanation

So $$A(x)$$, which again is

$$
\begin{equation}
A(x) = \frac{1}{1-(-1)^{S_{ij}}\frac{x}{2200}}
\label{eq:autocorr}
\end{equation}
$$ 

is intended to correct for "autocorrelation" in the model.  We see the function is designed so that

- If Team $$i$$ is the favorite ($$x>0$$), a loss is upweighted ($$A(x)>0$$) and a win is downweighted ($$A(x)<0$$).
- If Team $$i$$ is the underdog ($$x<0$$), the opposite.

So this *seems* like it would correct for over-inflation of rating due to a heavy favorite, and vice-versa for a big underdog, and perhaps solve our autocorrelation problem.

However, we are left with the questions: why achieve it *in this way*? And why use the denominator $d=2200$?



## Gettin stats-y

This whole issue arises because of the margin-of-victory $$M(z)$$ term we are including.  This isn't part of the "classical" Elo rating scheme, and it's messing everything up!  Without it, we have

$$
\begin{align*}
\mathbb{E}[R_k^{k+1}] &= \mathbb{E}[R_i^k] + \mathbb{E}[k(S_{ij}-\sigma(x))] \\
&= R_i^k + k(\mathbb{E}[S_{ij}] - \sigma(x)) \\
&= R_i^k 
\end{align*}
$$

which is just fine.  

But with $$M(z)$$, we need

$$
\mathbb{E}[M(z)\cdot A(x) \cdot (1 - \sigma(x))(-1)^{S_{ij}}] = 0
$$

which, computing expectation over all possible game outcomes as encoded in $$z$$, given $$R_i^k$$ and $$R_j^k$$, implies

$$
\int_{-\infty}^0 M(z) A(x) (\sigma(x)-1) \text{Pr}(z) \ dz + \int_0^{\infty} M(z) A(x) (1-\sigma(x)) \text{Pr}(z) \ dz = 0
$$

over some distribution for the margin $$z$$.  Rearranging, we get

$$
\begin{equation}
\frac{A(x; i \text{ win})}{A(x; i \text{ lose})} = \frac{\mathbb{E}[M(z)|i \text{ wins}]}{\mathbb{E}[M(z)|i \text{ lose}]}
\label{eq:goal}
\end{equation}
$$

and we want some $$A(x)$$ so this holds for any Elo delta $$x$$.

We should be able to interpolate some function for the expected $$M(z)$$'s, and then if we are satisfied with our functional form for $$A(x)$$, solve for the denominator $$d$$.

Let's try it.


## In search of d

We need to (1) work out the empirical conditional expectations for $$M(z)$$, then (2) approximate them with functions, and finally (3) solve for $$d$$ in terms of those functions.  

We can easily* pull boxscores, Elo ratings, and plot the mean $$M(z)$$'s.  (*easily defined as not really that easy, see code at the bottom of this post.)

Here's the expected $$M(z)$$ given various Elo rating deltas, based on the past 18 NFL seasons.

Image

Nice!  So the empirical (conditional) expectations we're after are both reasonably approximated by linear functions:

$$
\begin{align*}
\mathbb{E}[M(z)|i \text{ win}] &\approx \frac{x}{1000} + 2.2 \\
\mathbb{E}[M(z)|i \text{ lose}] &\approx -\frac{x}{1000} + 2.2
\end{align*}
$$

Returning to Eq. \eqref{eq:goal} and using our satisfying functional form for $$A(x)$$ from Eq. \eqref{eq:autocorr}, we have

$$
\begin{align*}
\frac{A(x; i \text{ wins})}{A(x; i \text{ lose})} &= 
\frac{\mathbb{E}[M(z)|i \text{ wins}]}{\mathbb{E}[M(z)|i \text{ lose}]} \\
\frac{1-x/d}{1+x/d} &\approx \frac{x/1000 + 2.2}{-x/1000 + 2.2}
\end{align*}
$$

which, carefully solving for $$d$$, gives $$d=2200$$.

Whoaaaaa.

